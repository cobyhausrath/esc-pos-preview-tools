<!DOCTYPE html>
<html>
<head>
    <title>Debug Test</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
    <h1>Debug Test</h1>
    <pre id="output"></pre>

    <script type="module">
        const output = document.getElementById('output');

        function log(msg) {
            output.textContent += msg + '\n';
            console.log(msg);
        }

        async function test() {
            try {
                log('1. Loading Pyodide...');
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                log('2. Pyodide loaded!');

                log('3. Loading micropip...');
                await pyodide.loadPackage("micropip");
                const micropip = pyodide.pyimport("micropip");
                log('4. Micropip loaded!');

                log('5. Installing python-escpos...');
                await micropip.install("python-escpos");
                log('6. python-escpos installed!');

                log('7. Testing simple code...');
                const code = `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Simple receipt
p.text('Hello, World!\\n')
p.text('This is a test receipt.\\n')
`;

                log('8. Executing code...');
                const result = await pyodide.runPythonAsync(`
from escpos.printer import Dummy
import sys
from io import StringIO

# Capture any print statements
old_stdout = sys.stdout
sys.stdout = StringIO()

try:
    # Create namespace for user code
    namespace = {'Dummy': Dummy}

    # Execute user code in namespace
    exec("""${code.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}""", namespace)

    # Get the printer instance from namespace
    p = namespace.get('p')
    if p is None:
        raise Exception("Code must create a printer instance named 'p'")

    # Get ESC-POS output
    output_bytes = list(p.output)

    # Get any print output
    print_output = sys.stdout.getvalue()

    output_bytes
except Exception as e:
    raise Exception(f"Execution error: {str(e)}")
finally:
    sys.stdout = old_stdout
                `);

                log('9. Result type: ' + typeof result);
                log('10. Result: ' + result);
                log('11. Result length: ' + (result ? result.length : 'null'));

                if (result) {
                    const escposBytes = new Uint8Array(result);
                    log('12. Bytes length: ' + escposBytes.length);
                    log('13. First 20 bytes: ' + Array.from(escposBytes.slice(0, 20)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));

                    // Test rendering
                    log('14. Testing text extraction...');
                    let text = '';
                    for (let i = 0; i < escposBytes.length; i++) {
                        const byte = escposBytes[i];
                        if (byte >= 0x20 && byte <= 0x7E) {
                            text += String.fromCharCode(byte);
                        } else if (byte === 0x0A) {
                            text += '\\n';
                        } else {
                            text += '[' + byte.toString(16).padStart(2, '0') + ']';
                        }
                    }
                    log('15. Text content: ' + text);
                }

                log('\n✓ Test completed successfully!');

            } catch (error) {
                log('✗ Error: ' + error.message);
                log('Stack: ' + error.stack);
            }
        }

        test();
    </script>
</body>
</html>
