<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Preview and print receipts, to-do lists, and images on thermal printers">
    <meta name="theme-color" content="#0e639c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Print Preview">
    <title>Thermal Print Preview - ESC-POS Receipt Editor</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons for iOS -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .preview-pane {
            flex: 0 0 420px;
            border-left: 1px solid #3e3e3e;
            overflow-y: auto;
            background: #252526;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .preview-header {
            padding: 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e3e;
        }

        .preview-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
        }

        .preview-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #editor {
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            outline: none;
            resize: none;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
        }

        #editor:focus {
            outline: none;
        }

        .status {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status.loading {
            background: #1a73e8;
            color: white;
        }

        .status.success {
            background: #0d7c2d;
            color: white;
        }

        .status.error {
            background: #c5221f;
            color: white;
        }

        .status.ready {
            background: #5f6368;
            color: white;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #0e639c;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #1177bb;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: #3e3e3e;
        }

        button.secondary:hover:not(:disabled) {
            background: #4e4e4e;
        }

        .receipt-container {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            width: 320px;  /* 80mm thermal paper width */
            max-width: 100%;
        }

        .receipt-content {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            color: black;
            white-space: pre-wrap;  /* Changed from pre to pre-wrap for proper wrapping */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .examples {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .receipt-line {
            margin: 0;
            padding: 0;
        }

        .receipt-line.center {
            text-align: center;
        }

        .receipt-line.right {
            text-align: right;
        }

        .error-message {
            color: #f48771;
            padding: 16px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .size-wide, .size-double {
            letter-spacing: 0.2em;
            font-size: 1.5em;
            font-weight: bold;
        }

        .size-tall, .size-double {
            font-size: 2em;
            line-height: 1.2;
        }

        #file-input {
            display: none;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: #3e3e3e;
            margin: 0 4px;
        }

        /* HEX View Panel */
        .hex-panel {
            background: #1e1e1e;
            border-bottom: 1px solid #3e3e3e;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .hex-panel.visible {
            max-height: 400px;
            overflow-y: auto;
        }

        .hex-content {
            padding: 16px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #d4d4d4;
            white-space: pre;
        }

        .hex-header {
            padding: 12px 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hex-header h4 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
        }

        .hex-stats {
            font-size: 12px;
            color: #858585;
        }

        .hex-offset {
            color: #858585;
        }

        .hex-bytes {
            color: #4ec9b0;
        }

        .hex-ascii {
            color: #ce9178;
        }

        button.toggle {
            background: transparent;
            border: 1px solid #3e3e3e;
        }

        button.toggle:hover:not(:disabled) {
            background: #3e3e3e;
            border-color: #4e4e4e;
        }

        button.toggle.active {
            background: #3e3e3e;
            border-color: #007acc;
        }

        /* Printer Controls */
        .printer-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #3e3e3e;
            border-radius: 4px;
            background: #2d2d30;
            color: #d4d4d4;
            cursor: pointer;
            font-size: 13px;
            outline: none;
        }

        select:hover {
            border-color: #4e4e4e;
        }

        select:focus {
            border-color: #007acc;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #858585;
        }

        .connection-status.connected {
            color: #0d7c2d;
        }

        .connection-status.disconnected {
            color: #c5221f;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #858585;
        }

        .status-dot.connected {
            background: #0d7c2d;
        }

        .status-dot.disconnected {
            background: #c5221f;
        }

        /* Template buttons in toolbar */
        .template-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button.template {
            background: #2d572c;
            font-size: 12px;
        }

        button.template:hover:not(:disabled) {
            background: #3d773c;
        }

        /* Mobile-responsive styles */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }

            .editor-pane {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .preview-pane {
                flex: 0 0 50vh;
                border-left: none;
                border-top: 1px solid #3e3e3e;
                max-height: 50vh;
            }

            .toolbar {
                padding: 8px;
                gap: 6px;
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .toolbar-group {
                flex-shrink: 0;
            }

            .examples {
                display: none; /* Hide example buttons on mobile */
            }

            .printer-controls {
                flex-shrink: 0;
            }

            button {
                padding: 10px 14px; /* Larger touch targets */
                font-size: 14px;
                white-space: nowrap;
            }

            button.template {
                padding: 8px 12px;
            }

            select {
                padding: 10px 12px;
                font-size: 14px;
            }

            #editor {
                font-size: 15px; /* Slightly larger for mobile */
                padding: 12px;
            }

            .receipt-container {
                width: 100%;
                max-width: 320px;
            }

            .preview-content {
                padding: 16px;
            }

            .hex-panel.visible {
                max-height: 250px; /* Smaller on mobile */
            }

            /* Show template buttons prominently on mobile */
            .template-group {
                order: -1; /* Move to start */
                width: 100%;
                margin-bottom: 8px;
            }

            .divider {
                display: none; /* Hide dividers on mobile */
            }

            /* Status in toolbar */
            #status {
                font-size: 12px;
                padding: 6px 10px;
            }

            .connection-status {
                font-size: 11px;
            }
        }

        /* Portrait mobile - stack vertically */
        @media (max-width: 480px) and (orientation: portrait) {
            .toolbar {
                flex-wrap: wrap;
            }

            .toolbar-group {
                width: 100%;
                justify-content: space-between;
            }

            .printer-controls {
                width: 100%;
            }

            select {
                flex: 1;
            }

            .preview-pane {
                flex: 0 0 60vh;
                max-height: 60vh;
            }
        }

        /* Landscape mobile - side by side */
        @media (max-width: 768px) and (orientation: landscape) {
            body {
                flex-direction: row;
            }

            .preview-pane {
                flex: 0 0 50vw;
                border-left: 1px solid #3e3e3e;
                border-top: none;
                max-height: none;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button {
                min-height: 44px; /* iOS recommended minimum */
                min-width: 44px;
            }

            select {
                min-height: 44px;
            }
        }

        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #0e639c;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            max-width: 90%;
        }

        .install-prompt.visible {
            display: flex;
        }

        .install-prompt button {
            background: white;
            color: #0e639c;
            padding: 8px 16px;
            margin: 0;
        }

        .install-prompt button:hover {
            background: #f0f0f0;
        }

        .install-prompt .close-btn {
            background: transparent;
            color: white;
            padding: 4px 8px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="editor-pane">
        <div class="toolbar">
            <div class="toolbar-group">
                <button id="run-btn" title="Run (Ctrl+Enter)">
                    ‚ñ∂ Run
                </button>
                <button id="import-btn" class="secondary" title="Import ESC-POS file">
                    üìÅ Import
                </button>
                <button id="export-btn" class="secondary" title="Export to ESC-POS">
                    üíæ Export
                </button>
                <button id="share-btn" class="secondary" title="Copy shareable link to clipboard">
                    üîó Share
                </button>
                <button id="hex-toggle-btn" class="toggle" title="Toggle HEX view">
                    üîç HEX
                </button>
            </div>

            <div class="divider"></div>

            <div class="printer-controls">
                <select id="printer-select">
                    <option value="">Select printer...</option>
                    <option value="netum">Netum 80-V-UL</option>
                    <option value="custom">Custom IP...</option>
                </select>
                <button id="print-btn" class="secondary" title="Send to printer" disabled>
                    üñ®Ô∏è Print
                </button>
                <span class="connection-status disconnected" id="connection-status">
                    <span class="status-dot disconnected"></span>
                    Disconnected
                </span>
            </div>

            <div class="divider"></div>

            <div class="template-group">
                <button id="template-timestamp" class="template" title="Print current date/time">üìÖ Now</button>
                <button id="template-expiry" class="template" title="Print expiration dates">‚è∞ Expiry</button>
                <button id="template-todo" class="template" title="Create to-do list">‚úì To-Do</button>
            </div>

            <div class="divider"></div>

            <div class="examples">
                <button id="example-simple" class="secondary">Simple</button>
                <button id="example-formatted" class="secondary">Formatted</button>
                <button id="example-receipt" class="secondary">Receipt</button>
            </div>

            <div class="divider"></div>

            <div id="status" class="status loading">
                <span class="loading-spinner"></span>
                Initializing Pyodide...
            </div>
        </div>
        <textarea id="editor" spellcheck="false"></textarea>
    </div>

    <div class="preview-pane">
        <!-- HEX View Panel (Collapsible) -->
        <div id="hex-panel" class="hex-panel">
            <div class="hex-header">
                <h4>HEX View</h4>
                <span class="hex-stats" id="hex-stats">0 bytes</span>
            </div>
            <div class="hex-content" id="hex-content">
                No data
            </div>
        </div>

        <!-- Receipt Preview -->
        <div class="preview-header">
            <h3>Receipt Preview (Live)</h3>
        </div>
        <div class="preview-content">
            <div id="preview">
                <div class="receipt-container">
                    <div class="receipt-content">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".bin,.txt,*">

    <!-- Install Prompt (shown when PWA can be installed) -->
    <div id="install-prompt" class="install-prompt">
        <span>üì≤ Install app for quick access</span>
        <button id="install-btn">Install</button>
        <button class="close-btn" id="install-close">‚úï</button>
    </div>

    <script type="module">
        // ===================================================================
        // Printer Client - WebSocket client for printer bridge
        // ===================================================================

        class PrinterClient {
            constructor(bridgeUrl = 'ws://127.0.0.1:8765') {
                this.bridgeUrl = bridgeUrl;
                this.ws = null;
                this.connected = false;
                this.printers = {};
                this.onStatusChange = null;
            }

            /**
             * Connect to printer bridge server
             * @returns {Promise<void>}
             */
            connect() {
                return new Promise((resolve, reject) => {
                    try {
                        this.ws = new WebSocket(this.bridgeUrl);

                        this.ws.onopen = () => {
                            console.log('Connected to printer bridge');
                            this.connected = true;
                            this.updateStatus('connected');
                        };

                        this.ws.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                console.log('Bridge message:', message);

                                if (message.printers) {
                                    this.printers = message.printers;
                                }

                                if (message.success !== undefined) {
                                    // Response to a request
                                    if (this.onResponse) {
                                        this.onResponse(message);
                                    }
                                }
                            } catch (err) {
                                console.error('Failed to parse bridge message:', err);
                            }
                        };

                        this.ws.onclose = () => {
                            console.log('Disconnected from printer bridge');
                            this.connected = false;
                            this.updateStatus('disconnected');
                        };

                        this.ws.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            this.connected = false;
                            this.updateStatus('disconnected');
                            reject(new Error('Failed to connect to printer bridge'));
                        };

                        // Wait for connection
                        const checkConnection = setInterval(() => {
                            if (this.connected) {
                                clearInterval(checkConnection);
                                resolve();
                            }
                        }, 100);

                        setTimeout(() => {
                            clearInterval(checkConnection);
                            if (!this.connected) {
                                reject(new Error('Connection timeout'));
                            }
                        }, 5000);

                    } catch (error) {
                        reject(error);
                    }
                });
            }

            /**
             * Disconnect from bridge
             */
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.connected = false;
                this.updateStatus('disconnected');
            }

            /**
             * Send data to printer
             * @param {string} printerName - Printer name or 'custom'
             * @param {Uint8Array} data - Binary data to send
             * @param {string} customHost - Custom host (if printerName is 'custom')
             * @param {number} customPort - Custom port (if printerName is 'custom')
             * @returns {Promise<{success: boolean, message?: string, error?: string}>}
             */
            sendToPrinter(printerName, data, customHost = null, customPort = null) {
                return new Promise((resolve, reject) => {
                    if (!this.connected) {
                        reject(new Error('Not connected to bridge'));
                        return;
                    }

                    const request = {
                        action: 'send',
                        data: Array.from(data)
                    };

                    if (printerName === 'custom') {
                        request.host = customHost;
                        request.port = customPort;
                    } else {
                        request.printer = printerName;
                    }

                    // Set response handler
                    this.onResponse = (message) => {
                        this.onResponse = null;
                        if (message.success) {
                            resolve(message);
                        } else {
                            reject(new Error(message.error || 'Unknown error'));
                        }
                    };

                    // Send request
                    this.ws.send(JSON.stringify(request));

                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (this.onResponse) {
                            this.onResponse = null;
                            reject(new Error('Request timeout'));
                        }
                    }, 10000);
                });
            }

            /**
             * Update connection status UI
             * @param {string} status - 'connected' or 'disconnected'
             */
            updateStatus(status) {
                if (this.onStatusChange) {
                    this.onStatusChange(status);
                }
            }
        }

        // ===================================================================
        // HEX Formatter - Display binary data as hex dump
        // ===================================================================

        class HexFormatter {
            /**
             * Format bytes as hex dump with offset, hex bytes, and ASCII
             * @param {Uint8Array} bytes - Binary data to format
             * @param {number} bytesPerLine - Bytes per line (default: 16)
             * @returns {string} Formatted hex dump
             */
            format(bytes, bytesPerLine = 16) {
                if (!bytes || bytes.length === 0) {
                    return 'No data';
                }

                let output = '';
                for (let i = 0; i < bytes.length; i += bytesPerLine) {
                    // Offset (8 hex digits)
                    const offset = i.toString(16).toUpperCase().padStart(8, '0');
                    output += `<span class="hex-offset">${offset}:</span> `;

                    // Hex bytes
                    const lineBytes = bytes.slice(i, i + bytesPerLine);
                    const hexPart = [];
                    for (let j = 0; j < bytesPerLine; j++) {
                        if (j < lineBytes.length) {
                            hexPart.push(lineBytes[j].toString(16).toUpperCase().padStart(2, '0'));
                        } else {
                            hexPart.push('  ');
                        }
                    }
                    output += `<span class="hex-bytes">${hexPart.join(' ')}</span>  `;

                    // ASCII representation
                    output += '| <span class="hex-ascii">';
                    for (let j = 0; j < lineBytes.length; j++) {
                        const byte = lineBytes[j];
                        // Printable ASCII or dot
                        const char = (byte >= 0x20 && byte <= 0x7E)
                            ? String.fromCharCode(byte)
                            : '.';
                        output += char;
                    }
                    output += '</span>\n';
                }

                return output;
            }

            /**
             * Get summary stats about the bytes
             * @param {Uint8Array} bytes - Binary data
             * @returns {string} Summary string
             */
            getStats(bytes) {
                if (!bytes || bytes.length === 0) {
                    return '0 bytes';
                }

                // Count command bytes (ESC, GS, etc.)
                let escCount = 0;
                let gsCount = 0;
                for (let i = 0; i < bytes.length; i++) {
                    if (bytes[i] === 0x1B) escCount++;
                    if (bytes[i] === 0x1D) gsCount++;
                }

                return `${bytes.length} bytes (ESC: ${escCount}, GS: ${gsCount})`;
            }
        }

        // ===================================================================
        // PWA & Share Target Utilities
        // ===================================================================

        /**
         * Register service worker for PWA functionality
         */
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('[PWA] Service worker registered:', registration.scope);
                    return registration;
                } catch (error) {
                    console.error('[PWA] Service worker registration failed:', error);
                    return null;
                }
            }
            return null;
        }

        /**
         * Handle PWA install prompt
         */
        let deferredInstallPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] Install prompt available');
            e.preventDefault();
            deferredInstallPrompt = e;

            // Show custom install prompt
            const installPrompt = document.getElementById('install-prompt');
            if (installPrompt) {
                installPrompt.classList.add('visible');
            }
        });

        /**
         * Retrieve shared image from IndexedDB
         */
        async function getSharedImage(imageId) {
            return new Promise((resolve, reject) => {
                const dbRequest = indexedDB.open('SharedImages', 1);

                dbRequest.onerror = () => reject(dbRequest.error);

                dbRequest.onsuccess = () => {
                    const db = dbRequest.result;
                    const transaction = db.transaction(['images'], 'readonly');
                    const store = transaction.objectStore('images');
                    const getRequest = store.get(imageId);

                    getRequest.onsuccess = () => {
                        const result = getRequest.result;
                        if (result) {
                            resolve({
                                data: result.data,
                                type: result.type
                            });
                            // Clean up - delete the shared image
                            const deleteTransaction = db.transaction(['images'], 'readwrite');
                            deleteTransaction.objectStore('images').delete(imageId);
                        } else {
                            reject(new Error('Image not found'));
                        }
                    };

                    getRequest.onerror = () => reject(getRequest.error);
                };
            });
        }

        /**
         * Template Generators
         */
        const Templates = {
            /**
             * Generate timestamp slip
             */
            timestamp() {
                const now = new Date();
                const date = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const time = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                return `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Current date/time stamp
p.set(align='center')
p.set(bold=True)
p.text('TIMESTAMP\\n')
p.set(bold=False)

p.text('\\n')

p.set(align='left')
p.text('Date: ${date}\\n')
p.text('Time: ${time}\\n')

p.text('\\n')

p.set(align='center')
p.text('--------------------------------\\n')
`;
            },

            /**
             * Generate expiration date calculator
             */
            expiry() {
                const now = new Date();
                const oneWeek = new Date(now);
                oneWeek.setDate(oneWeek.getDate() + 7);
                const twoWeeks = new Date(now);
                twoWeeks.setDate(twoWeeks.getDate() + 14);
                const oneMonth = new Date(now);
                oneMonth.setMonth(oneMonth.getMonth() + 1);

                const formatDate = (d) => d.toLocaleDateString('en-US', {
                    month: '2-digit',
                    day: '2-digit',
                    year: 'numeric'
                });

                return `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Expiration dates
p.set(align='center')
p.set(bold=True)
p.text('EXPIRATION DATES\\n')
p.set(bold=False)

p.text('\\n')

p.set(align='left')
p.text('Opened: ${formatDate(now)}\\n')
p.text('\\n')

p.text('+1 week:  ${formatDate(oneWeek)}\\n')
p.text('+2 weeks: ${formatDate(twoWeeks)}\\n')
p.text('+1 month: ${formatDate(oneMonth)}\\n')

p.text('\\n')

p.set(align='center')
p.text('--------------------------------\\n')
`;
            },

            /**
             * Generate to-do list template
             */
            todo(text = '') {
                // Parse text into todo items if provided
                let items = [];
                if (text) {
                    const lines = text.split('\n').filter(line => line.trim());
                    items = lines.map(line => {
                        // Check if it's a Google Keep style checkbox
                        const keepMatch = line.match(/^\[([x ])\]\s*(.+)$/);
                        if (keepMatch) {
                            return {
                                checked: keepMatch[1] === 'x',
                                text: keepMatch[2]
                            };
                        }
                        // Otherwise treat as unchecked item
                        return {
                            checked: false,
                            text: line.replace(/^[-*‚Ä¢]\s*/, '')
                        };
                    });
                }

                // Generate code
                let code = `from escpos.printer import Dummy

# Create printer
p = Dummy()

# To-Do List
p.set(align='center')
p.set(bold=True)
p.text('TO-DO LIST\\n')
p.set(bold=False)

p.text('\\n')

p.set(align='left')
`;

                if (items.length > 0) {
                    items.forEach(item => {
                        const checkbox = item.checked ? '[x]' : '[ ]';
                        const escaped = item.text.replace(/'/g, "\\\\'");
                        code += `p.text('${checkbox} ${escaped}\\\\n')\\n`;
                    });
                } else {
                    code += `p.text('[ ] Task 1\\\\n')
p.text('[ ] Task 2\\\\n')
p.text('[ ] Task 3\\\\n')
`;
                }

                code += `
p.text('\\\\n')

p.set(align='center')
p.text('--------------------------------\\\\n')
`;

                return code;
            },

            /**
             * Generate note from shared text
             */
            note(text, title = 'NOTE') {
                const escaped = text.replace(/'/g, "\\\\'").replace(/\\n/g, '\\\\n');

                return `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Note
p.set(align='center')
p.set(bold=True)
p.text('${title.toUpperCase()}\\\\n')
p.set(bold=False)

p.text('\\\\n')

p.set(align='left')
p.text('${escaped}\\\\n')

p.text('\\\\n')

p.set(align='center')
p.text('--------------------------------\\\\n')
`;
            }
        };

        // ===================================================================
        // Receipt Editor - Main Application
        // ===================================================================

        class ReceiptEditor {
            constructor() {
                this.pyodide = null;
                this.debounceTimer = null;
                this.isReady = false;
                this.hexFormatter = new HexFormatter();
                this.hexVisible = false;
                this.printerClient = new PrinterClient();
                this.currentBytes = null; // Store last generated bytes
                this.selectedPrinter = '';

                // Setup printer client status callback
                this.printerClient.onStatusChange = (status) => {
                    this.updateConnectionStatus(status);
                };
            }

            /**
             * Encode code to base64 for URL hash
             * @param {string} code - The code to encode
             * @returns {string} Base64-encoded code
             */
            encodeCodeToHash(code) {
                try {
                    // Use btoa for base64 encoding, but first encode URI components
                    // to handle special characters properly
                    return btoa(encodeURIComponent(code));
                } catch (error) {
                    console.error('Failed to encode code:', error);
                    return '';
                }
            }

            /**
             * Decode code from base64 URL hash
             * @param {string} hash - The base64 hash string
             * @returns {string|null} Decoded code or null if invalid
             */
            decodeCodeFromHash(hash) {
                try {
                    // Decode base64 and then decode URI components
                    return decodeURIComponent(atob(hash));
                } catch (error) {
                    console.error('Failed to decode hash:', error);
                    return null;
                }
            }

            /**
             * Get code from URL hash parameter
             * @returns {string|null} Code from hash or null
             */
            getCodeFromHash() {
                const hash = window.location.hash;
                if (!hash || hash.length <= 1) {
                    return null;
                }

                // Remove '#' and parse parameter
                const params = new URLSearchParams(hash.substring(1));
                const codeParam = params.get('code');

                if (!codeParam) {
                    return null;
                }

                return this.decodeCodeFromHash(codeParam);
            }

            /**
             * Update URL hash with current code
             * @param {string} code - The code to save in hash
             */
            updateHash(code) {
                const encoded = this.encodeCodeToHash(code);
                if (encoded) {
                    // Use replaceState to avoid adding to browser history
                    const newHash = `#code=${encoded}`;
                    window.history.replaceState(null, '', newHash);
                }
            }

            async init() {
                try {
                    this.updateStatus('loading', 'Loading Pyodide...');

                    // Load Pyodide
                    this.pyodide = await loadPyodide({
                        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                    });

                    this.updateStatus('loading', 'Installing python-escpos...');

                    // Install python-escpos
                    await this.pyodide.loadPackage("micropip");
                    const micropip = this.pyodide.pyimport("micropip");
                    await micropip.install("python-escpos");

                    this.updateStatus('success', 'Ready!');
                    this.isReady = true;

                    console.log('init: Pyodide ready, checking for hash parameters');

                    // Enable buttons
                    document.getElementById('run-btn').disabled = false;
                    document.getElementById('import-btn').disabled = false;
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('share-btn').disabled = false;

                    // Load code from hash if present, otherwise load default example
                    const codeFromHash = this.getCodeFromHash();
                    if (codeFromHash) {
                        console.log('init: Loading code from hash parameter');
                        document.getElementById('editor').value = codeFromHash;
                        this.runCode();
                    } else {
                        console.log('init: No hash parameter, loading default example');
                        this.loadExample('simple');
                    }
                    console.log('init: Complete');

                } catch (error) {
                    this.updateStatus('error', `Failed to initialize: ${error.message}`);
                    console.error(error);
                }
            }

            /**
             * Handle shared content from URL parameters
             */
            async handleSharedContent() {
                const params = new URLSearchParams(window.location.search);

                // Check for shared text
                if (params.has('shared') && params.get('shared') === 'text') {
                    const content = params.get('content');
                    if (content) {
                        console.log('[Share] Handling shared text:', content.substring(0, 100));

                        // Check if it looks like a to-do list
                        if (content.match(/^\[[ x]\]/m) || content.match(/^[-*‚Ä¢]\s/m)) {
                            const code = Templates.todo(content);
                            document.getElementById('editor').value = code;
                        } else {
                            // Regular note
                            const code = Templates.note(content);
                            document.getElementById('editor').value = code;
                        }

                        this.runCode();

                        // Clear URL parameters after handling
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }

                // Check for shared image
                if (params.has('imageId')) {
                    const imageId = params.get('imageId');
                    const imageType = params.get('imageType');

                    console.log('[Share] Handling shared image:', imageId, imageType);

                    try {
                        const imageData = await getSharedImage(imageId);
                        await this.handleSharedImage(imageData.data, imageData.type);

                        // Clear URL parameters after handling
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        console.error('[Share] Failed to load shared image:', error);
                        alert('Failed to load shared image. Please try again.');
                    }
                }

                // Check for template shortcuts
                if (params.has('template')) {
                    const template = params.get('template');
                    console.log('[Share] Loading template:', template);

                    switch (template) {
                        case 'date':
                            this.loadTemplate('timestamp');
                            break;
                        case 'todo':
                            this.loadTemplate('todo');
                            break;
                        case 'quick':
                            // Show quick action menu
                            break;
                    }

                    // Clear URL parameters after handling
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            /**
             * Handle shared image - process and generate ESC-POS code
             */
            async handleSharedImage(arrayBuffer, mimeType) {
                this.updateStatus('loading', 'Processing image...');

                try {
                    // Create image from array buffer
                    const blob = new Blob([arrayBuffer], { type: mimeType });
                    const imageUrl = URL.createObjectURL(blob);
                    const img = new Image();

                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = imageUrl;
                    });

                    // Process image with dithering
                    const processedData = await this.processImageForPrinting(img);

                    // Generate python-escpos code for the image
                    const code = this.generateImageCode(processedData);
                    document.getElementById('editor').value = code;

                    this.runCode();

                    URL.revokeObjectURL(imageUrl);
                } catch (error) {
                    this.updateStatus('error', 'Image processing failed');
                    console.error('[Image] Processing error:', error);
                    alert(`Image processing failed: ${error.message}`);
                }
            }

            /**
             * Process image for thermal printing
             * Applies Floyd-Steinberg dithering and resizes to printer width
             */
            async processImageForPrinting(img, maxWidth = 384) {
                // Create canvas for image processing
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Calculate dimensions maintaining aspect ratio
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = Math.floor((height * maxWidth) / width);
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                // Draw image
                ctx.drawImage(img, 0, 0, width, height);

                // Get image data
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;

                // Convert to grayscale and apply Floyd-Steinberg dithering
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;

                        // Convert to grayscale
                        const gray = Math.floor(
                            data[idx] * 0.299 +
                            data[idx + 1] * 0.587 +
                            data[idx + 2] * 0.114
                        );

                        // Threshold and calculate error
                        const newVal = gray < 128 ? 0 : 255;
                        const error = gray - newVal;

                        // Set pixel
                        data[idx] = data[idx + 1] = data[idx + 2] = newVal;

                        // Distribute error (Floyd-Steinberg)
                        if (x + 1 < width) {
                            const nextIdx = (y * width + x + 1) * 4;
                            data[nextIdx] += error * 7 / 16;
                            data[nextIdx + 1] += error * 7 / 16;
                            data[nextIdx + 2] += error * 7 / 16;
                        }

                        if (y + 1 < height) {
                            if (x > 0) {
                                const diagIdx = ((y + 1) * width + x - 1) * 4;
                                data[diagIdx] += error * 3 / 16;
                                data[diagIdx + 1] += error * 3 / 16;
                                data[diagIdx + 2] += error * 3 / 16;
                            }

                            const belowIdx = ((y + 1) * width + x) * 4;
                            data[belowIdx] += error * 5 / 16;
                            data[belowIdx + 1] += error * 5 / 16;
                            data[belowIdx + 2] += error * 5 / 16;

                            if (x + 1 < width) {
                                const diagIdx = ((y + 1) * width + x + 1) * 4;
                                data[diagIdx] += error * 1 / 16;
                                data[diagIdx + 1] += error * 1 / 16;
                                data[diagIdx + 2] += error * 1 / 16;
                            }
                        }
                    }
                }

                return { width, height, data: imageData };
            }

            /**
             * Generate python-escpos code for printing an image
             */
            generateImageCode(imageData) {
                // Convert image data to 1-bit bitmap
                const { width, height, data } = imageData;
                const bitmap = [];

                for (let y = 0; y < height; y++) {
                    const row = [];
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        row.push(data.data[idx] < 128 ? 1 : 0);
                    }
                    bitmap.push(row);
                }

                // Generate base64 representation for embedding (simplified)
                // In production, you'd want to properly encode this
                const code = `from escpos.printer import Dummy
from PIL import Image
import io
import base64

# Create printer
p = Dummy()

# Note: Image printing requires PIL/Pillow
# For now, we'll just print a placeholder
p.set(align='center')
p.text('IMAGE (${width}x${height})\\n')
p.text('\\n')

# In a real implementation, you would:
# 1. Convert the dithered image to a format python-escpos can use
# 2. Use p.image() to print it
# 3. Or use direct raster commands

p.text('Image printing coming soon!\\n')
`;

                return code;
            }

            /**
             * Load a template by name
             */
            loadTemplate(name) {
                console.log('[Template] Loading:', name);
                let code = '';

                switch (name) {
                    case 'timestamp':
                        code = Templates.timestamp();
                        break;
                    case 'expiry':
                        code = Templates.expiry();
                        break;
                    case 'todo':
                        code = Templates.todo();
                        break;
                    default:
                        console.error('[Template] Unknown template:', name);
                        return;
                }

                document.getElementById('editor').value = code;
                if (this.isReady) {
                    this.runCode();
                }
            }

            updateStatus(type, message) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${type}`;

                if (type === 'loading') {
                    statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
                } else {
                    statusEl.textContent = message;
                }
            }

            async runCode() {
                if (!this.isReady) {
                    console.log('runCode: Not ready yet');
                    return;
                }

                const code = document.getElementById('editor').value;
                console.log('runCode: Executing code, length:', code.length);

                try {
                    this.updateStatus('loading', 'Executing...');

                    // Execute python-escpos code in Pyodide
                    const result = await this.pyodide.runPythonAsync(`
from escpos.printer import Dummy
import sys
from io import StringIO

# Capture any print statements
old_stdout = sys.stdout
sys.stdout = StringIO()

result = None
try:
    # Create namespace for user code
    namespace = {'Dummy': Dummy}

    # Execute user code in namespace (using JSON.stringify for safe escaping)
    exec(${JSON.stringify(code)}, namespace)

    # Get the printer instance from namespace
    p = namespace.get('p')
    if p is None:
        raise Exception("Code must create a printer instance named 'p'")

    # Get ESC-POS output
    result = list(p.output)

except Exception as e:
    raise Exception(f"Execution error: {str(e)}")
finally:
    sys.stdout = old_stdout

result
                    `);

                    console.log('runCode: Result type:', typeof result);
                    console.log('runCode: Result:', result);

                    // Convert to Uint8Array
                    const escposBytes = new Uint8Array(result);
                    console.log('runCode: Bytes length:', escposBytes.length);
                    console.log('runCode: First 20 bytes:', Array.from(escposBytes.slice(0, 20)));

                    // Store bytes for printing
                    this.currentBytes = escposBytes;

                    // Update HEX view
                    this.updateHexView(escposBytes);

                    // Render preview
                    this.renderPreview(escposBytes);

                    this.updateStatus('success', `‚úì Success (${escposBytes.length} bytes)`);

                    // Update print button state
                    this.updateConnectionStatus(this.printerClient.connected ? 'connected' : 'disconnected');

                } catch (error) {
                    this.updateStatus('error', `‚úó Error`);
                    this.showError(error.message);
                    console.error('runCode error:', error);
                }
            }

            /**
             * Update the HEX view panel with new bytes
             * @param {Uint8Array} bytes - Binary data to display
             */
            updateHexView(bytes) {
                const hexContent = document.getElementById('hex-content');
                const hexStats = document.getElementById('hex-stats');

                hexContent.innerHTML = this.hexFormatter.format(bytes);
                hexStats.textContent = this.hexFormatter.getStats(bytes);
            }

            /**
             * Toggle HEX view visibility
             */
            toggleHexView() {
                this.hexVisible = !this.hexVisible;
                const hexPanel = document.getElementById('hex-panel');
                const hexToggleBtn = document.getElementById('hex-toggle-btn');

                if (this.hexVisible) {
                    hexPanel.classList.add('visible');
                    hexToggleBtn.classList.add('active');
                } else {
                    hexPanel.classList.remove('visible');
                    hexToggleBtn.classList.remove('active');
                }
            }

            /**
             * Connect to printer bridge
             */
            async connectToBridge() {
                try {
                    await this.printerClient.connect();
                    console.log('Connected to printer bridge');
                    return true;
                } catch (error) {
                    console.error('Failed to connect to bridge:', error);
                    return false;
                }
            }

            /**
             * Update connection status UI
             * @param {string} status - 'connected' or 'disconnected'
             */
            updateConnectionStatus(status) {
                const statusEl = document.getElementById('connection-status');
                const statusDot = statusEl.querySelector('.status-dot');
                const printBtn = document.getElementById('print-btn');

                statusEl.className = `connection-status ${status}`;
                statusDot.className = `status-dot ${status}`;
                statusEl.innerHTML = `
                    <span class="status-dot ${status}"></span>
                    ${status === 'connected' ? 'Connected' : 'Disconnected'}
                `;

                // Enable/disable print button based on connection and bytes available
                printBtn.disabled = !(status === 'connected' && this.currentBytes && this.currentBytes.length > 0);
            }

            /**
             * Send current bytes to printer
             */
            async sendToPrinter() {
                if (!this.currentBytes || this.currentBytes.length === 0) {
                    alert('No data to print. Run the code first.');
                    return;
                }

                if (!this.printerClient.connected) {
                    alert('Not connected to printer bridge. Make sure printer-bridge is running.');
                    return;
                }

                const printerSelect = document.getElementById('printer-select');
                const printerName = printerSelect.value;

                if (!printerName) {
                    alert('Please select a printer first.');
                    return;
                }

                try {
                    this.updateStatus('loading', 'Sending to printer...');

                    if (printerName === 'custom') {
                        const host = prompt('Enter printer IP address:', '192.168.1.100');
                        if (!host) return;

                        const portStr = prompt('Enter printer port:', '9100');
                        const port = parseInt(portStr, 10);
                        if (isNaN(port)) {
                            alert('Invalid port number');
                            return;
                        }

                        const result = await this.printerClient.sendToPrinter('custom', this.currentBytes, host, port);
                        this.updateStatus('success', `‚úì Printed ${result.bytesSent} bytes`);
                    } else {
                        const result = await this.printerClient.sendToPrinter(printerName, this.currentBytes);
                        this.updateStatus('success', `‚úì Printed ${result.bytesSent} bytes`);
                    }

                } catch (error) {
                    this.updateStatus('error', `Print failed: ${error.message}`);
                    alert(`Print failed: ${error.message}`);
                }
            }

            renderPreview(escposBytes) {
                // Simple ESC-POS parser and renderer
                console.log('renderPreview: Called with', escposBytes.length, 'bytes');
                const preview = document.getElementById('preview');

                let html = '<div class="receipt-container"><div class="receipt-content">';
                let currentAlign = 'left';
                let currentBold = false;
                let currentUnderline = false;
                let currentLine = '';
                let i = 0;
                let lineCount = 0;

                while (i < escposBytes.length) {
                    const byte = escposBytes[i];

                    // ESC sequences
                    if (byte === 0x1B && i + 1 < escposBytes.length) {
                        const cmd = escposBytes[i + 1];

                        // ESC @ - Initialize
                        if (cmd === 0x40) {
                            i += 2;
                            continue;
                        }

                        // ESC a - Alignment
                        if (cmd === 0x61 && i + 2 < escposBytes.length) {
                            if (currentLine) {
                                html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                                lineCount++;
                                currentLine = '';
                            }
                            const align = escposBytes[i + 2];
                            currentAlign = align === 1 ? 'center' : align === 2 ? 'right' : 'left';
                            i += 3;
                            continue;
                        }

                        // ESC E - Bold
                        if (cmd === 0x45 && i + 2 < escposBytes.length) {
                            currentBold = escposBytes[i + 2] !== 0;
                            i += 3;
                            continue;
                        }

                        // ESC - - Underline
                        if (cmd === 0x2D && i + 2 < escposBytes.length) {
                            currentUnderline = escposBytes[i + 2] !== 0;
                            i += 3;
                            continue;
                        }

                        i += 2;
                        continue;
                    }

                    // GS sequences
                    if (byte === 0x1D && i + 1 < escposBytes.length) {
                        const cmd = escposBytes[i + 1];

                        // GS V - Cut
                        if (cmd === 0x56 && i + 2 < escposBytes.length) {
                            if (currentLine) {
                                html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                                lineCount++;
                                currentLine = '';
                            }
                            html += '<div class="receipt-line center">--- ‚úÇ ---</div>';
                            lineCount++;
                            i += 3;
                            continue;
                        }

                        i += 2;
                        continue;
                    }

                    // Line feed
                    if (byte === 0x0A) {
                        html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                        lineCount++;
                        currentLine = '';
                        i++;
                        continue;
                    }

                    // Printable ASCII
                    if (byte >= 0x20 && byte <= 0x7E) {
                        currentLine += String.fromCharCode(byte);
                        i++;
                        continue;
                    }

                    // Skip other bytes
                    i++;
                }

                // Flush remaining line
                if (currentLine) {
                    html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                    lineCount++;
                }

                html += '</div></div>';
                console.log('renderPreview: Generated', lineCount, 'lines');
                console.log('renderPreview: HTML length:', html.length);
                console.log('renderPreview: HTML preview:', html.substring(0, 200));
                preview.innerHTML = html;
                console.log('renderPreview: Done');
            }

            /**
             * Format a line of receipt text with styling
             * @param {string} text - The text content
             * @param {string} align - Alignment: 'left', 'center', or 'right'
             * @param {boolean} bold - Whether text should be bold
             * @param {boolean} underline - Whether text should be underlined
             * @returns {string} HTML string for the formatted line
             */
            formatLine(text, align, bold, underline) {
                if (!text && text !== '') return '';

                let style = '';
                if (bold) text = `<strong>${text}</strong>`;
                if (underline) text = `<u>${text}</u>`;

                return `<div class="receipt-line ${align}">${text || '&nbsp;'}</div>`;
            }

            showError(message) {
                const preview = document.getElementById('preview');
                preview.innerHTML = `
                    <div class="receipt-container">
                        <div class="error-message">Error:\n${this.escapeHtml(message)}</div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            loadExample(name) {
                console.log('loadExample:', name);
                const examples = {
                    simple: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Simple receipt
p.text('Hello, World!\\n')
p.text('This is a test receipt.\\n')
`,

                    formatted: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Formatted text
p.set(align='center')
p.set(bold=True)
p.text('FORMATTED TEXT\\n')
p.set(bold=False)

p.text('\\n')

p.set(align='left')
p.text('Normal text\\n')

p.set(bold=True)
p.text('Bold text\\n')
p.set(bold=False)

p.set(underline=1)
p.text('Underlined text\\n')
p.set(underline=0)

p.text('\\n')

p.set(align='center')
p.text('Centered text\\n')

p.set(align='right')
p.text('Right-aligned\\n')
`,

                    receipt: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Store header
p.set(align='center')
p.set(bold=True)
p.set(width=2, height=2)
p.text('COFFEE SHOP\\n')
p.set(width=1, height=1)
p.set(bold=False)
p.text('123 Main Street\\n')
p.text('Tel: (555) 123-4567\\n')

p.text('\\n')

# Receipt details
p.set(align='left')
p.text('Date: 2024-01-15 14:30\\n')
p.text('Order #: 1234\\n')

p.text('\\n')
p.text('--------------------------------\\n')

# Items
p.text('Cappuccino           $4.50\\n')
p.text('Croissant            $3.25\\n')
p.text('Latte                $4.75\\n')

p.text('--------------------------------\\n')

# Total
p.set(bold=True)
p.text('TOTAL:              $12.50\\n')
p.set(bold=False)

p.text('\\n')

# Footer
p.set(align='center')
p.text('Thank you!\\n')
p.text('Please come again\\n')

p.text('\\n')

# Cut paper
p.cut(mode='FULL')
`
                };

                document.getElementById('editor').value = examples[name];
                console.log('loadExample: Set editor value, isReady:', this.isReady);
                if (this.isReady) {
                    console.log('loadExample: Calling onCodeChange');
                    this.onCodeChange();
                }
            }

            onCodeChange() {
                console.log('onCodeChange: Debouncing...');
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    console.log('onCodeChange: Debounce complete, calling runCode and updating hash');
                    const code = document.getElementById('editor').value;
                    this.updateHash(code);
                    this.runCode();
                }, 500); // 500ms debounce
            }

            async importFile(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const bytes = new Uint8Array(arrayBuffer);

                    // For now, just display the raw bytes
                    // In future, use the verifier to convert to Python
                    this.renderPreview(bytes);
                    this.updateStatus('success', `Imported ${bytes.length} bytes`);

                } catch (error) {
                    this.updateStatus('error', `Import failed: ${error.message}`);
                }
            }

            async exportFile() {
                try {
                    const code = document.getElementById('editor').value;

                    // Execute code to get ESC-POS bytes
                    const result = await this.pyodide.runPythonAsync(`
from escpos.printer import Dummy
p = Dummy()
exec(${JSON.stringify(code)})
list(p.output)
                    `);

                    const bytes = new Uint8Array(result);

                    // Create blob and download
                    const blob = new Blob([bytes], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'receipt.bin';
                    a.click();
                    URL.revokeObjectURL(url);

                    this.updateStatus('success', `‚úì Exported ${bytes.length} bytes`);

                } catch (error) {
                    this.updateStatus('error', `Export failed: ${error.message}`);
                }
            }

            /**
             * Share the current code by copying URL to clipboard
             */
            async shareCode() {
                try {
                    const code = document.getElementById('editor').value;

                    // Update hash to ensure URL is current
                    this.updateHash(code);

                    // Copy current URL to clipboard
                    const url = window.location.href;
                    await navigator.clipboard.writeText(url);

                    // Show success message
                    const originalStatus = document.getElementById('status').textContent;
                    this.updateStatus('success', '‚úì Link copied to clipboard!');

                    // Restore original status after 2 seconds
                    setTimeout(() => {
                        if (this.isReady) {
                            this.updateStatus('success', originalStatus);
                        }
                    }, 2000);

                } catch (error) {
                    this.updateStatus('error', `Share failed: ${error.message}`);
                }
            }
        }

        // ===================================================================
        // Initialize Application
        // ===================================================================

        const editor = new ReceiptEditor();

        window.addEventListener('load', async () => {
            // Register service worker for PWA
            registerServiceWorker();

            // Setup event listeners and get button references
            const editorEl = document.getElementById('editor');
            const runBtn = document.getElementById('run-btn');
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const shareBtn = document.getElementById('share-btn');
            const hexToggleBtn = document.getElementById('hex-toggle-btn');
            const printBtn = document.getElementById('print-btn');
            const printerSelect = document.getElementById('printer-select');
            const fileInput = document.getElementById('file-input');

            // Template buttons
            const templateTimestamp = document.getElementById('template-timestamp');
            const templateExpiry = document.getElementById('template-expiry');
            const templateTodo = document.getElementById('template-todo');

            // Install prompt
            const installBtn = document.getElementById('install-btn');
            const installClose = document.getElementById('install-close');
            const installPrompt = document.getElementById('install-prompt');

            // Disable buttons until ready
            runBtn.disabled = true;
            importBtn.disabled = true;
            exportBtn.disabled = true;
            shareBtn.disabled = true;
            printBtn.disabled = true;

            // Run button
            runBtn.addEventListener('click', () => editor.runCode());

            // Auto-run on change
            editorEl.addEventListener('input', () => editor.onCodeChange());

            // Ctrl+Enter to run
            editorEl.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    editor.runCode();
                }
            });

            // Tab key support
            editorEl.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editorEl.selectionStart;
                    const end = editorEl.selectionEnd;
                    editorEl.value = editorEl.value.substring(0, start) + '    ' + editorEl.value.substring(end);
                    editorEl.selectionStart = editorEl.selectionEnd = start + 4;
                }
            });

            // Import button
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    editor.importFile(e.target.files[0]);
                }
            });

            // Export button
            exportBtn.addEventListener('click', () => editor.exportFile());

            // Share button
            shareBtn.addEventListener('click', () => editor.shareCode());

            // HEX toggle button
            hexToggleBtn.addEventListener('click', () => editor.toggleHexView());

            // Print button
            printBtn.addEventListener('click', () => editor.sendToPrinter());

            // Printer select
            printerSelect.addEventListener('change', (e) => {
                editor.selectedPrinter = e.target.value;
            });

            // Example buttons
            document.getElementById('example-simple').addEventListener('click', () => editor.loadExample('simple'));
            document.getElementById('example-formatted').addEventListener('click', () => editor.loadExample('formatted'));
            document.getElementById('example-receipt').addEventListener('click', () => editor.loadExample('receipt'));

            // Template buttons
            templateTimestamp.addEventListener('click', () => editor.loadTemplate('timestamp'));
            templateExpiry.addEventListener('click', () => editor.loadTemplate('expiry'));
            templateTodo.addEventListener('click', () => editor.loadTemplate('todo'));

            // Install prompt handlers
            installBtn.addEventListener('click', async () => {
                if (deferredInstallPrompt) {
                    deferredInstallPrompt.prompt();
                    const { outcome } = await deferredInstallPrompt.userChoice;
                    console.log('[PWA] Install prompt result:', outcome);
                    deferredInstallPrompt = null;
                    installPrompt.classList.remove('visible');
                }
            });

            installClose.addEventListener('click', () => {
                installPrompt.classList.remove('visible');
            });

            // Initialize editor (this will enable buttons when ready)
            await editor.init();

            // Handle shared content from URL parameters (after init)
            await editor.handleSharedContent();

            // Try to connect to printer bridge (optional)
            // This will fail silently if bridge is not running
            setTimeout(async () => {
                try {
                    await editor.connectToBridge();
                } catch (error) {
                    console.log('Printer bridge not available (this is okay)');
                }
            }, 1000);

            // Expose for debugging
            window.receiptEditor = editor;
        });
    </script>
</body>
</html>
