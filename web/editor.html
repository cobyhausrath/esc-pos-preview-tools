<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESC-POS Receipt Editor - Powered by Pyodide</title>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .preview-pane {
            flex: 0 0 420px;
            border-left: 1px solid #3e3e3e;
            overflow-y: auto;
            background: #252526;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            padding: 12px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .preview-header {
            padding: 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e3e;
        }

        .preview-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
        }

        .preview-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #editor {
            flex: 1;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            outline: none;
            resize: none;
            overflow-y: auto;
            white-space: pre;
            tab-size: 4;
        }

        #editor:focus {
            outline: none;
        }

        .status {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status.loading {
            background: #1a73e8;
            color: white;
        }

        .status.success {
            background: #0d7c2d;
            color: white;
        }

        .status.error {
            background: #c5221f;
            color: white;
        }

        .status.ready {
            background: #5f6368;
            color: white;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #0e639c;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #1177bb;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: #3e3e3e;
        }

        button.secondary:hover:not(:disabled) {
            background: #4e4e4e;
        }

        .receipt-container {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            width: 320px;  /* 80mm thermal paper width */
            max-width: 100%;
        }

        .receipt-content {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            color: black;
            white-space: pre-wrap;  /* Changed from pre to pre-wrap for proper wrapping */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .examples {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .receipt-line {
            margin: 0;
            padding: 0;
        }

        .receipt-line.center {
            text-align: center;
        }

        .receipt-line.right {
            text-align: right;
        }

        .error-message {
            color: #f48771;
            padding: 16px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .size-wide, .size-double {
            letter-spacing: 0.2em;
            font-size: 1.5em;
            font-weight: bold;
        }

        .size-tall, .size-double {
            font-size: 2em;
            line-height: 1.2;
        }

        #file-input {
            display: none;
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: #3e3e3e;
            margin: 0 4px;
        }
    </style>
</head>
<body>
    <div class="editor-pane">
        <div class="toolbar">
            <div class="toolbar-group">
                <button id="run-btn" title="Run (Ctrl+Enter)">
                    ‚ñ∂ Run
                </button>
                <button id="import-btn" class="secondary" title="Import ESC-POS file">
                    üìÅ Import
                </button>
                <button id="export-btn" class="secondary" title="Export to ESC-POS">
                    üíæ Export
                </button>
                <button id="share-btn" class="secondary" title="Copy shareable link to clipboard">
                    üîó Share
                </button>
            </div>

            <div class="divider"></div>

            <div class="examples">
                <button id="example-simple" class="secondary">Simple</button>
                <button id="example-formatted" class="secondary">Formatted</button>
                <button id="example-receipt" class="secondary">Receipt</button>
            </div>

            <div class="divider"></div>

            <div id="status" class="status loading">
                <span class="loading-spinner"></span>
                Initializing Pyodide...
            </div>
        </div>
        <textarea id="editor" spellcheck="false"></textarea>
    </div>

    <div class="preview-pane">
        <div class="preview-header">
            <h3>Receipt Preview (Live)</h3>
        </div>
        <div class="preview-content">
            <div id="preview">
                <div class="receipt-container">
                    <div class="receipt-content">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept=".bin,.txt,*">

    <script type="module">
        // ===================================================================
        // Receipt Editor - Main Application
        // ===================================================================

        class ReceiptEditor {
            constructor() {
                this.pyodide = null;
                this.debounceTimer = null;
                this.isReady = false;
            }

            /**
             * Encode code to base64 for URL hash
             * @param {string} code - The code to encode
             * @returns {string} Base64-encoded code
             */
            encodeCodeToHash(code) {
                try {
                    // Use btoa for base64 encoding, but first encode URI components
                    // to handle special characters properly
                    return btoa(encodeURIComponent(code));
                } catch (error) {
                    console.error('Failed to encode code:', error);
                    return '';
                }
            }

            /**
             * Decode code from base64 URL hash
             * @param {string} hash - The base64 hash string
             * @returns {string|null} Decoded code or null if invalid
             */
            decodeCodeFromHash(hash) {
                try {
                    // Decode base64 and then decode URI components
                    return decodeURIComponent(atob(hash));
                } catch (error) {
                    console.error('Failed to decode hash:', error);
                    return null;
                }
            }

            /**
             * Get code from URL hash parameter
             * @returns {string|null} Code from hash or null
             */
            getCodeFromHash() {
                const hash = window.location.hash;
                if (!hash || hash.length <= 1) {
                    return null;
                }

                // Remove '#' and parse parameter
                const params = new URLSearchParams(hash.substring(1));
                const codeParam = params.get('code');

                if (!codeParam) {
                    return null;
                }

                return this.decodeCodeFromHash(codeParam);
            }

            /**
             * Update URL hash with current code
             * @param {string} code - The code to save in hash
             */
            updateHash(code) {
                const encoded = this.encodeCodeToHash(code);
                if (encoded) {
                    // Use replaceState to avoid adding to browser history
                    const newHash = `#code=${encoded}`;
                    window.history.replaceState(null, '', newHash);
                }
            }

            async init() {
                try {
                    this.updateStatus('loading', 'Loading Pyodide...');

                    // Load Pyodide
                    this.pyodide = await loadPyodide({
                        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                    });

                    this.updateStatus('loading', 'Installing python-escpos...');

                    // Install python-escpos
                    await this.pyodide.loadPackage("micropip");
                    const micropip = this.pyodide.pyimport("micropip");
                    await micropip.install("python-escpos");

                    this.updateStatus('success', 'Ready!');
                    this.isReady = true;

                    console.log('init: Pyodide ready, checking for hash parameters');

                    // Enable buttons
                    document.getElementById('run-btn').disabled = false;
                    document.getElementById('import-btn').disabled = false;
                    document.getElementById('export-btn').disabled = false;
                    document.getElementById('share-btn').disabled = false;

                    // Load code from hash if present, otherwise load default example
                    const codeFromHash = this.getCodeFromHash();
                    if (codeFromHash) {
                        console.log('init: Loading code from hash parameter');
                        document.getElementById('editor').value = codeFromHash;
                        this.runCode();
                    } else {
                        console.log('init: No hash parameter, loading default example');
                        this.loadExample('simple');
                    }
                    console.log('init: Complete');

                } catch (error) {
                    this.updateStatus('error', `Failed to initialize: ${error.message}`);
                    console.error(error);
                }
            }

            updateStatus(type, message) {
                const statusEl = document.getElementById('status');
                statusEl.className = `status ${type}`;

                if (type === 'loading') {
                    statusEl.innerHTML = `<span class="loading-spinner"></span>${message}`;
                } else {
                    statusEl.textContent = message;
                }
            }

            async runCode() {
                if (!this.isReady) {
                    console.log('runCode: Not ready yet');
                    return;
                }

                const code = document.getElementById('editor').value;
                console.log('runCode: Executing code, length:', code.length);

                try {
                    this.updateStatus('loading', 'Executing...');

                    // Execute python-escpos code in Pyodide
                    const result = await this.pyodide.runPythonAsync(`
from escpos.printer import Dummy
import sys
from io import StringIO

# Capture any print statements
old_stdout = sys.stdout
sys.stdout = StringIO()

result = None
try:
    # Create namespace for user code
    namespace = {'Dummy': Dummy}

    # Execute user code in namespace (using JSON.stringify for safe escaping)
    exec(${JSON.stringify(code)}, namespace)

    # Get the printer instance from namespace
    p = namespace.get('p')
    if p is None:
        raise Exception("Code must create a printer instance named 'p'")

    # Get ESC-POS output
    result = list(p.output)

except Exception as e:
    raise Exception(f"Execution error: {str(e)}")
finally:
    sys.stdout = old_stdout

result
                    `);

                    console.log('runCode: Result type:', typeof result);
                    console.log('runCode: Result:', result);

                    // Convert to Uint8Array
                    const escposBytes = new Uint8Array(result);
                    console.log('runCode: Bytes length:', escposBytes.length);
                    console.log('runCode: First 20 bytes:', Array.from(escposBytes.slice(0, 20)));

                    // Render preview
                    this.renderPreview(escposBytes);

                    this.updateStatus('success', `‚úì Success (${escposBytes.length} bytes)`);

                } catch (error) {
                    this.updateStatus('error', `‚úó Error`);
                    this.showError(error.message);
                    console.error('runCode error:', error);
                }
            }

            renderPreview(escposBytes) {
                // Simple ESC-POS parser and renderer
                console.log('renderPreview: Called with', escposBytes.length, 'bytes');
                const preview = document.getElementById('preview');

                let html = '<div class="receipt-container"><div class="receipt-content">';
                let currentAlign = 'left';
                let currentBold = false;
                let currentUnderline = false;
                let currentLine = '';
                let i = 0;
                let lineCount = 0;

                while (i < escposBytes.length) {
                    const byte = escposBytes[i];

                    // ESC sequences
                    if (byte === 0x1B && i + 1 < escposBytes.length) {
                        const cmd = escposBytes[i + 1];

                        // ESC @ - Initialize
                        if (cmd === 0x40) {
                            i += 2;
                            continue;
                        }

                        // ESC a - Alignment
                        if (cmd === 0x61 && i + 2 < escposBytes.length) {
                            if (currentLine) {
                                html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                                lineCount++;
                                currentLine = '';
                            }
                            const align = escposBytes[i + 2];
                            currentAlign = align === 1 ? 'center' : align === 2 ? 'right' : 'left';
                            i += 3;
                            continue;
                        }

                        // ESC E - Bold
                        if (cmd === 0x45 && i + 2 < escposBytes.length) {
                            currentBold = escposBytes[i + 2] !== 0;
                            i += 3;
                            continue;
                        }

                        // ESC - - Underline
                        if (cmd === 0x2D && i + 2 < escposBytes.length) {
                            currentUnderline = escposBytes[i + 2] !== 0;
                            i += 3;
                            continue;
                        }

                        i += 2;
                        continue;
                    }

                    // GS sequences
                    if (byte === 0x1D && i + 1 < escposBytes.length) {
                        const cmd = escposBytes[i + 1];

                        // GS V - Cut
                        if (cmd === 0x56 && i + 2 < escposBytes.length) {
                            if (currentLine) {
                                html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                                lineCount++;
                                currentLine = '';
                            }
                            html += '<div class="receipt-line center">--- ‚úÇ ---</div>';
                            lineCount++;
                            i += 3;
                            continue;
                        }

                        i += 2;
                        continue;
                    }

                    // Line feed
                    if (byte === 0x0A) {
                        html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                        lineCount++;
                        currentLine = '';
                        i++;
                        continue;
                    }

                    // Printable ASCII
                    if (byte >= 0x20 && byte <= 0x7E) {
                        currentLine += String.fromCharCode(byte);
                        i++;
                        continue;
                    }

                    // Skip other bytes
                    i++;
                }

                // Flush remaining line
                if (currentLine) {
                    html += this.formatLine(currentLine, currentAlign, currentBold, currentUnderline);
                    lineCount++;
                }

                html += '</div></div>';
                console.log('renderPreview: Generated', lineCount, 'lines');
                console.log('renderPreview: HTML length:', html.length);
                console.log('renderPreview: HTML preview:', html.substring(0, 200));
                preview.innerHTML = html;
                console.log('renderPreview: Done');
            }

            /**
             * Format a line of receipt text with styling
             * @param {string} text - The text content
             * @param {string} align - Alignment: 'left', 'center', or 'right'
             * @param {boolean} bold - Whether text should be bold
             * @param {boolean} underline - Whether text should be underlined
             * @returns {string} HTML string for the formatted line
             */
            formatLine(text, align, bold, underline) {
                if (!text && text !== '') return '';

                let style = '';
                if (bold) text = `<strong>${text}</strong>`;
                if (underline) text = `<u>${text}</u>`;

                return `<div class="receipt-line ${align}">${text || '&nbsp;'}</div>`;
            }

            showError(message) {
                const preview = document.getElementById('preview');
                preview.innerHTML = `
                    <div class="receipt-container">
                        <div class="error-message">Error:\n${this.escapeHtml(message)}</div>
                    </div>
                `;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            loadExample(name) {
                console.log('loadExample:', name);
                const examples = {
                    simple: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Simple receipt
p.text('Hello, World!\\n')
p.text('This is a test receipt.\\n')
`,

                    formatted: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Formatted text
p.set(align='center')
p.set(bold=True)
p.text('FORMATTED TEXT\\n')
p.set(bold=False)

p.text('\\n')

p.set(align='left')
p.text('Normal text\\n')

p.set(bold=True)
p.text('Bold text\\n')
p.set(bold=False)

p.set(underline=1)
p.text('Underlined text\\n')
p.set(underline=0)

p.text('\\n')

p.set(align='center')
p.text('Centered text\\n')

p.set(align='right')
p.text('Right-aligned\\n')
`,

                    receipt: `from escpos.printer import Dummy

# Create printer
p = Dummy()

# Store header
p.set(align='center')
p.set(bold=True)
p.set(width=2, height=2)
p.text('COFFEE SHOP\\n')
p.set(width=1, height=1)
p.set(bold=False)
p.text('123 Main Street\\n')
p.text('Tel: (555) 123-4567\\n')

p.text('\\n')

# Receipt details
p.set(align='left')
p.text('Date: 2024-01-15 14:30\\n')
p.text('Order #: 1234\\n')

p.text('\\n')
p.text('--------------------------------\\n')

# Items
p.text('Cappuccino           $4.50\\n')
p.text('Croissant            $3.25\\n')
p.text('Latte                $4.75\\n')

p.text('--------------------------------\\n')

# Total
p.set(bold=True)
p.text('TOTAL:              $12.50\\n')
p.set(bold=False)

p.text('\\n')

# Footer
p.set(align='center')
p.text('Thank you!\\n')
p.text('Please come again\\n')

p.text('\\n')

# Cut paper
p.cut(mode='FULL')
`
                };

                document.getElementById('editor').value = examples[name];
                console.log('loadExample: Set editor value, isReady:', this.isReady);
                if (this.isReady) {
                    console.log('loadExample: Calling onCodeChange');
                    this.onCodeChange();
                }
            }

            onCodeChange() {
                console.log('onCodeChange: Debouncing...');
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    console.log('onCodeChange: Debounce complete, calling runCode and updating hash');
                    const code = document.getElementById('editor').value;
                    this.updateHash(code);
                    this.runCode();
                }, 500); // 500ms debounce
            }

            async importFile(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const bytes = new Uint8Array(arrayBuffer);

                    // For now, just display the raw bytes
                    // In future, use the verifier to convert to Python
                    this.renderPreview(bytes);
                    this.updateStatus('success', `Imported ${bytes.length} bytes`);

                } catch (error) {
                    this.updateStatus('error', `Import failed: ${error.message}`);
                }
            }

            async exportFile() {
                try {
                    const code = document.getElementById('editor').value;

                    // Execute code to get ESC-POS bytes
                    const result = await this.pyodide.runPythonAsync(`
from escpos.printer import Dummy
p = Dummy()
exec(${JSON.stringify(code)})
list(p.output)
                    `);

                    const bytes = new Uint8Array(result);

                    // Create blob and download
                    const blob = new Blob([bytes], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'receipt.bin';
                    a.click();
                    URL.revokeObjectURL(url);

                    this.updateStatus('success', `‚úì Exported ${bytes.length} bytes`);

                } catch (error) {
                    this.updateStatus('error', `Export failed: ${error.message}`);
                }
            }

            /**
             * Share the current code by copying URL to clipboard
             */
            async shareCode() {
                try {
                    const code = document.getElementById('editor').value;

                    // Update hash to ensure URL is current
                    this.updateHash(code);

                    // Copy current URL to clipboard
                    const url = window.location.href;
                    await navigator.clipboard.writeText(url);

                    // Show success message
                    const originalStatus = document.getElementById('status').textContent;
                    this.updateStatus('success', '‚úì Link copied to clipboard!');

                    // Restore original status after 2 seconds
                    setTimeout(() => {
                        if (this.isReady) {
                            this.updateStatus('success', originalStatus);
                        }
                    }, 2000);

                } catch (error) {
                    this.updateStatus('error', `Share failed: ${error.message}`);
                }
            }
        }

        // ===================================================================
        // Initialize Application
        // ===================================================================

        const editor = new ReceiptEditor();

        window.addEventListener('load', async () => {
            // Setup event listeners and get button references
            const editorEl = document.getElementById('editor');
            const runBtn = document.getElementById('run-btn');
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const shareBtn = document.getElementById('share-btn');
            const fileInput = document.getElementById('file-input');

            // Disable buttons until ready
            runBtn.disabled = true;
            importBtn.disabled = true;
            exportBtn.disabled = true;
            shareBtn.disabled = true;

            // Run button
            runBtn.addEventListener('click', () => editor.runCode());

            // Auto-run on change
            editorEl.addEventListener('input', () => editor.onCodeChange());

            // Ctrl+Enter to run
            editorEl.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    editor.runCode();
                }
            });

            // Tab key support
            editorEl.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = editorEl.selectionStart;
                    const end = editorEl.selectionEnd;
                    editorEl.value = editorEl.value.substring(0, start) + '    ' + editorEl.value.substring(end);
                    editorEl.selectionStart = editorEl.selectionEnd = start + 4;
                }
            });

            // Import button
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    editor.importFile(e.target.files[0]);
                }
            });

            // Export button
            exportBtn.addEventListener('click', () => editor.exportFile());

            // Share button
            shareBtn.addEventListener('click', () => editor.shareCode());

            // Example buttons
            document.getElementById('example-simple').addEventListener('click', () => editor.loadExample('simple'));
            document.getElementById('example-formatted').addEventListener('click', () => editor.loadExample('formatted'));
            document.getElementById('example-receipt').addEventListener('click', () => editor.loadExample('receipt'));

            // Initialize editor (this will enable buttons when ready)
            await editor.init();

            // Expose for debugging
            window.receiptEditor = editor;
        });
    </script>
</body>
</html>
